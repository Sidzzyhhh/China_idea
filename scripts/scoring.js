export const factors = [
  {
    id: 'careerMomentum',
    title: 'èŒä¸šåŠ¨èƒ½',
    tagline: 'STEM / é‡‘è / å’¨è¯¢çª—å£',
    icon: 'ğŸ›°ï¸',
    description:
      'å…³æ³¨OPTè½¬æ­£ç‡ã€è£å‘˜èŠ‚å¥ä¸å²—ä½å¢é•¿ã€‚ç»“åˆç¾å›½ Tech hiring reboundã€å›½å†…ç¡¬ç§‘æŠ€è¡¥è´´ã€æ–°åŠ å¡é‡‘èç‰Œç…§ç­‰çª—å£ã€‚',
    defaultValue: 7,
    lowLabel: 'å¯ä»¥æ…¢æ…¢æ¥',
    highLabel: 'å¿…é¡»ç«‹å³å…‘ç°',
    cues: ['LinkedIn / Levels FYI æ–°å¢èŒä½', 'å›½å†…ç¡¬ç§‘æŠ€åŸºé‡‘', 'ç¬¬ä¸‰åœ°é•¿ç­¾æ”¯æŒ'],
  },
  {
    id: 'visaCertainty',
    title: 'ç­¾è¯ä¸èº«ä»½ç¨³å®š',
    tagline: 'H-1B / O-1 / æµ·å¤–æ°¸å±…',
    icon: 'ğŸ›‚',
    description:
      'è¡¡é‡æŠ½ç­¾æ¦‚ç‡ã€èº«ä»½ç»­æœŸæˆæœ¬ä»¥åŠé…å¶èº«ä»½ã€‚ç¾å›½H-1B ä¸­ç­¾ç‡ä¸‹é™ã€å›½å†…å›æµå…ç­¾ã€åŠ æ‹¿å¤§TR2PRç­‰æ–¹æ¡ˆéƒ½ä¼šå½±å“ã€‚',
    defaultValue: 8,
    lowLabel: 'é£é™©å¯æ§',
    highLabel: 'å¿…é¡»é”å®šèº«ä»½',
    cues: ['USCIS æŠ½ç­¾ç‡', 'ä¸­å›½æˆ·ç±ä¸è½æˆ·', 'åŠ æ‹¿å¤§å¿«é€Ÿé€šé“'],
  },
  {
    id: 'fundingOutlook',
    title: 'ç§‘ç ”ä¸èµ„é‡‘',
    tagline: 'PhD Funding / Lab Pipeline',
    icon: 'ğŸ§ª',
    description:
      'å…³æ³¨å¯¼å¸ˆç»è´¹ã€å®éªŒå®¤è£å‘˜ã€å›½å†…é«˜æ°´å¹³ç§‘ç ”è®¡åˆ’ä»¥åŠæ¬§ç›Ÿ Horizon é¡¹ç›®ã€‚',
    defaultValue: 6,
    lowLabel: 'å¯è‡ªç­¹',
    highLabel: 'éœ€è¦ç¨³å®šèµ„åŠ©',
    cues: ['NSF / NIH é¢„ç®—', 'å›½å†…ç›´åšå²—ä½', 'æ¬§ç›Ÿ Marie Curie'],
  },
  {
    id: 'financialSafety',
    title: 'ä¸ªäººç°é‡‘æµ',
    tagline: 'ç”Ÿæ´»æˆæœ¬ / å®¶åº­æ”¯æŒ',
    icon: 'ğŸ’¹',
    description:
      'æ¯”è¾ƒæ¹¾åŒº/çº½çº¦ç”Ÿæ´»æˆæœ¬ã€å›½å†…ä¸€çº¿åŸå¸‚ç§Ÿé‡‘ã€ç¬¬ä¸‰åœ°ç¨è´Ÿä¸åŒ»ç–—æˆæœ¬ã€‚',
    defaultValue: 5,
    lowLabel: 'æœ‰ç¼“å†²',
    highLabel: 'å¿…é¡»é™æœ¬',
    cues: ['Numbeo ç”Ÿæ´»æŒ‡æ•°', 'å›½å†…ä½æˆ¿æ”¯æŒ', 'æ–°åŠ å¡ CPF / ç¨ç‡'],
  },
  {
    id: 'communitySupport',
    title: 'æ”¯æŒç³»ç»Ÿ',
    tagline: 'ç¤¾äº¤åœˆ / å¿ƒç†å¥åº·',
    icon: 'ğŸ«±ğŸ»â€ğŸ«²ğŸ¼',
    description:
      'è€ƒè™‘å®¶äººè·ç¦»ã€åŒæ¸©å±‚ç¤¾åŒºã€å¿ƒç†å’¨è¯¢èµ„æºä»¥åŠæ–‡åŒ–é€‚é…ã€‚',
    defaultValue: 4,
    lowLabel: 'ç‹¬è‡ªè¡ŒåŠ¨',
    highLabel: 'éœ€è¦å¯†é›†é™ªä¼´',
    cues: ['æ ¡å›­å¿ƒç†å’¨è¯¢', 'æµ·å½’ç¤¾åŒº', 'å›½é™…ç”Ÿç½‘ç»œ'],
  },
  {
    id: 'globalMobility',
    title: 'å…¨çƒæœºåŠ¨æ€§',
    tagline: 'å¤šå›½èº«ä»½ / èŒä¸šå¼¹æ€§',
    icon: 'ğŸŒ',
    description:
      'å…³æ³¨å¤šå›½å·¥ä½œè®¸å¯ã€è¿œç¨‹å·¥ä½œçš„æ³•å¾‹æ¡†æ¶ä»¥åŠåˆ›ä¸šç­¾è¯ã€‚',
    defaultValue: 6,
    lowLabel: 'æœ¬åœŸæ·±è€•',
    highLabel: 'ä¿æŒå…¨çƒè·³æ¿',
    cues: ['Digital Nomad Visa', 'æ¸¯æ¾³äººæ‰é€š', 'æ¬§ç›Ÿè“å¡'],
  },
];

export const regressionMatrix = {
  stayUS: {
    careerMomentum: 0.92,
    visaCertainty: 0.48,
    fundingOutlook: 0.68,
    financialSafety: 0.55,
    communitySupport: 0.62,
    globalMobility: 0.74,
  },
  returnCN: {
    careerMomentum: 0.71,
    visaCertainty: 0.95,
    fundingOutlook: 0.82,
    financialSafety: 0.76,
    communitySupport: 0.88,
    globalMobility: 0.63,
  },
  exploreGlobal: {
    careerMomentum: 0.76,
    visaCertainty: 0.63,
    fundingOutlook: 0.74,
    financialSafety: 0.69,
    communitySupport: 0.73,
    globalMobility: 0.91,
  },
};

export const pathMeta = {
  stayUS: {
    label: 'ç•™åœ¨ç¾å›½å»¶ä¼¸',
    tone: 'ç»§ç»­æ‹‰å‡åŒ—ç¾å±¥å†ï¼Œè§£å†³èº«ä»½æ˜¯å…³é”®é˜»åŠ›ã€‚',
  },
  returnCN: {
    label: 'å›å›½åŠ é€Ÿ',
    tone: 'ä¾æ‰˜äº§ä¸šæ”¿ç­–ä¸å®¶äººç½‘ç»œï¼Œè½åœ°é€Ÿåº¦æ˜¯ä¼˜åŠ¿ã€‚',
  },
  exploreGlobal: {
    label: 'ç¬¬ä¸‰åœ°è·³æ¿',
    tone: 'åˆ©ç”¨å¼€æ”¾ç§»æ°‘æ”¿ç­–ä¸ç¨æ”¶å·¥å…·ï¼Œä¿æŒæµåŠ¨æ€§ã€‚',
  },
};

export function calculateScores(priorities, matrix = regressionMatrix) {
  const totals = {};
  const normalized = {};
  let maxScore = 0;
  let minScore = Number.POSITIVE_INFINITY;

  for (const [path, factorsMap] of Object.entries(matrix)) {
    let weightedSum = 0;
    let weightTotal = 0;
    for (const [factorId, priority] of Object.entries(priorities)) {
      const baseline = factorsMap[factorId] ?? 0;
      weightedSum += priority * baseline;
      weightTotal += priority;
    }
    const meanScore = weightTotal > 0 ? weightedSum / weightTotal : 0;
    totals[path] = meanScore;
    maxScore = Math.max(maxScore, meanScore);
    minScore = Math.min(minScore, meanScore);
  }

  if (!Number.isFinite(minScore)) minScore = 0;
  if (!Number.isFinite(maxScore) || maxScore === minScore) {
    for (const path of Object.keys(totals)) {
      normalized[path] = Math.round(totals[path] * 100);
    }
    return { raw: totals, normalized };
  }

  for (const [path, value] of Object.entries(totals)) {
    const scaled = (value - minScore) / (maxScore - minScore);
    normalized[path] = Math.round(scaled * 100);
  }

  return { raw: totals, normalized };
}

export function rankPaths(scores) {
  return Object.entries(scores)
    .sort((a, b) => b[1] - a[1])
    .map(([path]) => path);
}

export function buildCallouts({ raw, normalized }, priorities) {
  const ranking = rankPaths(normalized);
  const topPath = ranking[0];
  const runnerUp = ranking[1];
  const delta = Math.abs(normalized[topPath] - normalized[runnerUp ?? topPath]);
  const focusFactor = Object.entries(priorities)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 2)
    .map(([factorId]) => factorId);

  const callouts = [];
  if (delta <= 8) {
    callouts.push({
      title: 'å·®è·æå°',
      body: 'ä¸¤ä¸ªå¤‡é€‰è·¯å¾„æ¥è¿‘æ‰“å¹³ã€‚å»ºè®®è¿›ä¸€æ­¥æ ¸å®è–ªèµ„ã€ç­¾è¯æ—¶é—´çº¿ç­‰ç¡¬æ•°æ®ã€‚',
    });
  } else if (delta >= 25) {
    callouts.push({
      title: 'é¢†å…ˆæ¸…æ™°',
      body: `${pathMeta[topPath].label} æ˜¾è‘—é¢†å…ˆï¼Œå¯é›†ä¸­èµ„æºå†²åˆºï¼ŒåŒæ—¶é¢„ç•™ Plan Bã€‚`,
    });
  } else {
    callouts.push({
      title: 'ä¿æŒåŠ¨æ€è¿½è¸ª',
      body: `${pathMeta[topPath].label} ç•¥å ä¼˜åŠ¿ï¼Œå…³æ³¨åŠå¹´å†…çš„æ”¿ç­–/èµ„é‡‘æ³¢åŠ¨ã€‚`,
    });
  }

  for (const factorId of focusFactor) {
    const factor = factors.find((item) => item.id === factorId);
    if (!factor) continue;
    callouts.push({
      title: `${factor.title} æ˜¯æ ¸å¿ƒå˜é‡`,
      body: `${factor.description.split('ã€‚')[0]}ã€‚ä¼˜å…ˆæŠŠè¿™é¡¹çš„æ•°æ®åšå¾—æ›´é€æ˜ã€‚`,
    });
  }

  return callouts;
}

export function generateInsights({ normalized }, priorities) {
  const ranking = rankPaths(normalized);
  const insights = [];
  const topPath = ranking[0];
  const bottomPath = ranking[ranking.length - 1];

  insights.push({
    term: 'å½“å‰æœ€ä¼˜è·¯å¾„',
    detail: `${pathMeta[topPath].label} Â· ${pathMeta[topPath].tone}`,
  });

  insights.push({
    term: 'æœ€å¼±è·¯å¾„',
    detail: `${pathMeta[bottomPath].label} åˆ†å€¼åä½ï¼Œå¯ç»“åˆæƒé‡æ£€æŸ¥æ˜¯å¦ä½ä¼°äº†å®ƒçš„èµ„æºã€‚`,
  });

  const highestPriority = Object.entries(priorities).sort((a, b) => b[1] - a[1])[0];
  if (highestPriority) {
    const factor = factors.find((item) => item.id === highestPriority[0]);
    insights.push({
      term: 'æœ€é«˜æƒé‡',
      detail: `${factor.title}ï¼š${factor.tagline}`,
    });
  }

  return insights;
}

export function normalizeSliderValue(value, min = 0, max = 10) {
  const clamped = Math.min(Math.max(value, min), max);
  return clamped / (max - min || 1);
}
